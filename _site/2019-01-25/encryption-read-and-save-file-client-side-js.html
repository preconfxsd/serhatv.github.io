<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Encryption and File Reading/Saving with JavaScript &middot; Atralfamadorian
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
</head>


  <body>
    <nav class="nav">
      <div class="nav-container">
        <ul>
          <li><a href="/"><h2 class="nav-title">Atralfamadorian</h2></a></li>
          <li><a href="/readfirst">read first.</a></li>
          <!--<li><a href="/pick">Pick the best</a></li>-->
          <li><a href="/">thought.</a></li>
          <li><a href="/">curation.</a></li>
          <li><a href="/">critic.</a></li>
          <li><a href="/">.all</a></li>
        </ul>
    </div>
  </nav>

    <main>
      <div class="post">
  

  <h1 class="post-title">Encryption and File Reading/Saving with JavaScript</h1>

  <h3 id="the-problem">The problem</h3>

<p>It was about reading the log files on local disk which encoded in Base64 and encrypted by XOR operations. Then to save the decrypted data.</p>

<p><img src="/assets/images/log-encryption-chart.png" alt="graph" /></p>

<p>As you see in the graph, Log file encoded with Base64 and saved in a log file. Our goal is to read that encrypted log and by using the hash we calculated, extract the original log data.</p>

<h3 id="reversing-the-process-above">Reversing the process above</h3>

<p>To achieve that, I will use the client side js libraries. Here is my path:</p>

<ol>
  <li>Read file</li>
  <li>Generate sha256 hash from given key</li>
  <li>Convert log content and hashed key to ByteArray (assume that file content is in Base64 format)</li>
  <li>Apply XOR operations with given algorithm (I will discuss later)</li>
  <li>Get Base64 format from output ByteArray</li>
  <li>Convert to string</li>
</ol>

<p>First, to convert to/from ByteArray I found a library  (because <code class="highlighter-rouge">atob()</code> and <code class="highlighter-rouge">btoa()</code> js functions have problem with utf-8 chars)(<a href="https://github.com/beatgammit/base64-js/">base64js</a>) and coded this function :</p>

<p><code class="highlighter-rouge">utils.js</code></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Base64Encode</span><span class="p">(</span><span class="nx">bytes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">base64js</span><span class="p">.</span><span class="nx">fromByteArray</span><span class="p">(</span><span class="nx">bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">Base64Decode</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">base64js</span><span class="p">.</span><span class="nx">toByteArray</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I couldn’t find any default methods for conversion of string &lt;-&gt; ByteArray so copied these from one of google’s libs (<a href="https://github.com/google/closure-library/blob/8598d87242af59aac233270742c8984e2b2bdbe0/closure/goog/crypt/crypt.js#L117-L143">link</a>):</p>

<p><code class="highlighter-rouge">utils.js</code></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">stringToUtf8ByteArray</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">192</span><span class="p">;</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">|</span> <span class="mi">128</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
        <span class="p">((</span><span class="nx">c</span> <span class="o">&amp;</span> <span class="mh">0xFC00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xD800</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span>
        <span class="p">((</span><span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFC00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xDC00</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Surrogate Pair</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="mh">0x10000</span> <span class="o">+</span> <span class="p">((</span><span class="nx">c</span> <span class="o">&amp;</span> <span class="mh">0x03FF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03FF</span><span class="p">);</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="mi">240</span><span class="p">;</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nx">c</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">|</span> <span class="mi">128</span><span class="p">;</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nx">c</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">|</span> <span class="mi">128</span><span class="p">;</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">|</span> <span class="mi">128</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mi">224</span><span class="p">;</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nx">c</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">|</span> <span class="mi">128</span><span class="p">;</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">|</span> <span class="mi">128</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">utf8ByteArrayToString</span> <span class="p">(</span><span class="nx">bytes</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c1</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">c1</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">c</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">c1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c1</span> <span class="o">&gt;</span> <span class="mi">191</span> <span class="o">&amp;&amp;</span> <span class="nx">c1</span> <span class="o">&lt;</span> <span class="mi">224</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c2</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">];</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">c</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">((</span><span class="nx">c1</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="nx">c2</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c1</span> <span class="o">&gt;</span> <span class="mi">239</span> <span class="o">&amp;&amp;</span> <span class="nx">c1</span> <span class="o">&lt;</span> <span class="mi">365</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Surrogate Pair</span>
      <span class="kd">var</span> <span class="nx">c2</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">c3</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">c4</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">u</span> <span class="o">=</span> <span class="p">((</span><span class="nx">c1</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span> <span class="o">|</span> <span class="p">(</span><span class="nx">c2</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="p">(</span><span class="nx">c3</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="nx">c4</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">-</span>
          <span class="mh">0x10000</span><span class="p">;</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">c</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mh">0xD800</span> <span class="o">+</span> <span class="p">(</span><span class="nx">u</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">c</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mh">0xDC00</span> <span class="o">+</span> <span class="p">(</span><span class="nx">u</span> <span class="o">&amp;</span> <span class="mi">1023</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c2</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">c3</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">];</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">c</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
          <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">((</span><span class="nx">c1</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="p">(</span><span class="nx">c2</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="nx">c3</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">out</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>After that I coded a function to apply the decoding process. The algorithm simply loops through the hashed key and applies XOR operation to the each byte.
<code class="highlighter-rouge">utils.js</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">decryptStringXOR</span><span class="p">(</span><span class="nx">encodedStr</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">decodedStr</span> <span class="o">=</span> <span class="nx">Base64Decode</span><span class="p">(</span><span class="nx">encodedStr</span><span class="p">);</span> <span class="c1">//assume that str is already encoded</span>
  <span class="kd">var</span> <span class="nx">strBytes</span> <span class="o">=</span> <span class="nx">stringToUtf8ByteArray</span><span class="p">(</span><span class="nx">decodedStr</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">keyBytes</span> <span class="o">=</span> <span class="nx">stringToUtf8ByteArray</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">outBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">strBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">strBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">outBytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">strBytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">^</span> <span class="nx">keyBytes</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">keyBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">outStr</span> <span class="o">=</span> <span class="nx">utf8ByteArrayToString</span><span class="p">(</span><span class="nx">outBytes</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">outStr</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//To generate str to test</span>
<span class="kd">function</span> <span class="nx">encryptStringXOR</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">strBytes</span> <span class="o">=</span> <span class="nx">stringToUtf8ByteArray</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">keyBytes</span> <span class="o">=</span> <span class="nx">stringToUtf8ByteArray</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">outBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">strBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">strBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">outBytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">strBytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">^</span> <span class="nx">keyBytes</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">keyBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">outStr</span> <span class="o">=</span> <span class="nx">Base64Encode</span><span class="p">(</span><span class="nx">utf8ByteArrayToString</span><span class="p">(</span><span class="nx">outBytes</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">outStr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>To generate sha256 hashes, I used the <a href="https://github.com/emn178/js-sha256">js-sha256</a> lib.</p>
</blockquote>

<blockquote>
  <p>To read log file from local disk, I’ve used <a href="https://developer.mozilla.org/tr/docs/Web/API/FileReader">FileReader</a> API.</p>
</blockquote>

<h3 id="combine-them-all">Combine them all</h3>

<p>Simply, when the file selected via input field, I read file and applied decoding methods above. Using another library (<a href="https://github.com/tmpvar/browser-filesaver">browser-filesaver</a>) made the job easier with <code class="highlighter-rouge">saveAs(blob)</code> method to save the final log file.</p>

<p><code class="highlighter-rouge">main.js</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">selectFileField</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="nx">readFile</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="kd">function</span> <span class="nx">readFile</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>

    <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">hashed</span> <span class="o">=</span> <span class="nx">sha256</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">logContent</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
      <span class="nx">logContent</span> <span class="o">=</span> <span class="nx">logContent</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">logContent</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// have to remove last '\n' char</span>
      <span class="kd">var</span> <span class="nx">decryptedStr</span> <span class="o">=</span> <span class="nx">encryptStringXOR</span><span class="p">(</span><span class="nx">logContent</span><span class="p">,</span> <span class="nx">hashed</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">decryptedStr</span><span class="p">],</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s2">"text/plain;charset=utf-8"</span><span class="p">});</span>
      <span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span> <span class="s2">"encrypted_"</span><span class="o">+</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsBinaryString</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><em>end</em></p>



</div>

<div class="pagination">
  
  
    <a href="/2018-10-27/processing-ii" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>

    </main>

    <footer>

    </footer>
  </body>
</html>
